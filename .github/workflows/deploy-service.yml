name: Backend - Build & Push ECR (no CloudFormation deploy)

on:
  push:
    branches: ["main"]
    paths:
      - "project/**"
      - ".github/workflows/backend-build-push-only.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      user: ${{ steps.filter.outputs.user }}
      notification: ${{ steps.filter.outputs.notification }}
      chatbox: ${{ steps.filter.outputs.chatbox }}
      event: ${{ steps.filter.outputs.event }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            user:
              - 'project/user-service/**'
            notification:
              - 'project/notification-service/**'
            chatbox:
              - 'project/chatbox-service/**'
            event:
              - 'project/event-service/**'

  build-and-push:
    needs: detect
    runs-on: ubuntu-latest
    if: |
      needs.detect.outputs.user == 'true' ||
      needs.detect.outputs.notification == 'true' ||
      needs.detect.outputs.chatbox == 'true' ||
      needs.detect.outputs.event == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute tags
        id: meta
        run: |
          echo "SHA_TAG=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "SHORT_TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      # USER
      - name: Build & push user-service
        if: needs.detect.outputs.user == 'true'
        run: |
          REPO="${{ vars.ECR_REPO_USER }}"
          URI="${{ steps.meta.outputs.ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com/${REPO}"

          docker build -f project/user-service/Dockerfile -t "${URI}:${{ steps.meta.outputs.SHA_TAG }}" .
          docker tag "${URI}:${{ steps.meta.outputs.SHA_TAG }}" "${URI}:latest"

          docker push "${URI}:${{ steps.meta.outputs.SHA_TAG }}"
          docker push "${URI}:latest"

          echo "Pushed: ${URI}:${{ steps.meta.outputs.SHORT_TAG }} (and latest)"

      # NOTIFICATION
      - name: Build & push notification-service
        if: needs.detect.outputs.notification == 'true'
        run: |
          REPO="${{ vars.ECR_REPO_NOTIFICATION }}"
          URI="${{ steps.meta.outputs.ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com/${REPO}"

          docker build -f project/notification-service/Dockerfile -t "${URI}:${{ steps.meta.outputs.SHA_TAG }}" .
          docker tag "${URI}:${{ steps.meta.outputs.SHA_TAG }}" "${URI}:latest"

          docker push "${URI}:${{ steps.meta.outputs.SHA_TAG }}"
          docker push "${URI}:latest"

      # CHATBOX
      - name: Build & push chatbox-service
        if: needs.detect.outputs.chatbox == 'true'
        run: |
          REPO="${{ vars.ECR_REPO_CHATBOX }}"
          URI="${{ steps.meta.outputs.ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com/${REPO}"

          docker build -f project/chatbox-service/Dockerfile -t "${URI}:${{ steps.meta.outputs.SHA_TAG }}" .
          docker tag "${URI}:${{ steps.meta.outputs.SHA_TAG }}" "${URI}:latest"

          docker push "${URI}:${{ steps.meta.outputs.SHA_TAG }}"
          docker push "${URI}:latest"

      # EVENT
      - name: Build & push event-service
        if: needs.detect.outputs.event == 'true'
        run: |
          REPO="${{ vars.ECR_REPO_EVENT }}"
          URI="${{ steps.meta.outputs.ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com/${REPO}"

          docker build -f project/event-service/Dockerfile -t "${URI}:${{ steps.meta.outputs.SHA_TAG }}" .
          docker tag "${URI}:${{ steps.meta.outputs.SHA_TAG }}" "${URI}:latest"

          docker push "${URI}:${{ steps.meta.outputs.SHA_TAG }}"
          docker push "${URI}:latest"